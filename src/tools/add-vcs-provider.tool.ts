import { z } from "zod";
import { createToolResponse } from "../utils";
import { AddVcsProviderRequestDto } from "../types/dto/add-vcs-provider-request.dto";
import { addVcsProviderAction } from "../actions/add-vcs-provider.action";
import { ToolNames } from "../types/tool-names.enum";
import { VcsProviders } from "../types/vcs-providers.enum";

const inputSchema = {
  url: z
    .string({
      description: `URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTTPS. –ü—Ä–∏–º–µ—Ä https://github.com/username/repo.git. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ .git/config –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ`,
    })
    .url("URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º"),
  login: z
    .string({
      description: `–õ–û–ì–ò–ù –î–õ–Ø –î–û–°–¢–£–ü–ê –ö –†–ï–ü–û–ó–ò–¢–û–†–ò–Æ.
        üîí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤!

        –ï—Å–ª–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
        ‚Ä¢ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å/—Ç–æ–∫–µ–Ω —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ‚Ä¢ –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ü–ï–†–ï–ó–ê–ü–†–û–°–ò–¢–¨ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏`,
    })
    .optional(),
  password: z
    .string({
      description: `–ü–ê–†–û–õ–¨ –ò–õ–ò –¢–û–ö–ï–ù –î–õ–Ø –î–û–°–¢–£–ü–ê –ö –†–ï–ü–û–ó–ò–¢–û–†–ò–Æ.
        üîí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤!

        –í–∞—Ä–∏–∞–Ω—Ç—ã:
        ‚Ä¢ Personal Access Token (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
        ‚Ä¢ –ü–∞—Ä–æ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞

        –ï—Å–ª–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
        ‚Ä¢ –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–æ–∫–µ–Ω/–ø–∞—Ä–æ–ª—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ‚Ä¢ –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ü–ï–†–ï–ó–ê–ü–†–û–°–ò–¢–¨ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏`,
    })
    .optional(),
  provider_type: z.nativeEnum(VcsProviders, {
    description: "–¢–∏–ø VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞",
  }),
};

const outputSchema = {
  provider: z.string({
    description: "–¢–∏–ø VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –í—Å–µ–≥–¥–∞ git",
  }),
  provider_id: z.string({
    description: "ID –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ Timeweb Cloud",
  }),
  login: z.string({
    description: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ Timeweb Cloud",
  }),
};

const handler = async (params: AddVcsProviderRequestDto) => {
  try {

    if (!params.provider_type) {
      return createToolResponse(
        `‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ç–∏–ø VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞!`
      );
    }

    if (params.provider_type === VcsProviders.GIT) {
      await addVcsProviderAction(params);
    } else {
      // TODO: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
      return createToolResponse(
        `‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–∏–ø VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ git –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–µ`
      );
    }


    return createToolResponse(`‚úÖ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!

üìã –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:
‚Ä¢ –¢–∏–ø: ${params.provider_type}
‚Ä¢ URL: ${params.url}
${params.login ? `‚Ä¢ –õ–æ–≥–∏–Ω: ${params.login}` : ""}
${params.password ? `‚Ä¢ –ü–∞—Ä–æ–ª—å/—Ç–æ–∫–µ–Ω: ***` : ""}

üéâ –ü—Ä–æ–≤–∞–π–¥–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–ª—è –¥–µ–ø–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π!`);
  } catch (error) {
    if (error instanceof Error) {
      const errorMessage = error.message.toLowerCase();

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      if (
        errorMessage.includes("unauthorized") ||
        errorMessage.includes("403") ||
        errorMessage.includes("401")
      ) {
        return createToolResponse(
          `‚ùå –û–®–ò–ë–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞!

üîç –ü—Ä–∏—á–∏–Ω–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

üí° –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ª–æ–≥–∏–Ω–∞ –∏ —Ç–æ–∫–µ–Ω–∞/–ø–∞—Ä–æ–ª—è

üîÑ –ù–ï–û–ë–•–û–î–ò–ú–û –ü–ï–†–ï–ó–ê–ü–†–û–°–ò–¢–¨ –î–ê–ù–ù–´–ï:
‚Ä¢ –õ–æ–≥–∏–Ω (username)
‚Ä¢ –ü–∞—Ä–æ–ª—å/—Ç–æ–∫–µ–Ω —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: ${error.message}`
        );
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      if (
        errorMessage.includes("repository not found") ||
        errorMessage.includes("404") ||
        errorMessage.includes("not found")
      ) {
        return createToolResponse(
          `‚ùå –†–ï–ü–û–ó–ò–¢–û–†–ò–ô –ù–ï –ù–ê–ô–î–ï–ù!

üîç –ü—Ä–∏—á–∏–Ω–∞: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

üí° –†–ï–®–ï–ù–ò–ï:
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é

–¢–µ–∫—É—â–∏–π URL: ${params.url}`
        );
      }

      // –û–±—â–∞—è –æ—à–∏–±–∫–∞
      return createToolResponse(
        `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞!

üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: ${error.message}

üí° –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
‚Ä¢ –£–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ª–æ–≥–∏–Ω
‚Ä¢ –£–∫–∞–∑–∞–Ω –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω/–ø–∞—Ä–æ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
‚Ä¢ –¢–æ–∫–µ–Ω –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ scope (repo, read/write)`
      );
    }

    return createToolResponse(
      `‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`
    );
  }
};

export const addVcsProviderTool = {
  name: ToolNames.ADD_VCS_PROVIDER,
  title: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞",
  description: `–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∫ Timeweb Cloud`,
  inputSchema,
  outputSchema,
  handler,
};

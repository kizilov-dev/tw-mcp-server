import { z } from "zod";
import { AppTypes } from "../types/app-types.enum";
import {
  FrameworksBackend,
  FrameworksFrontend,
} from "../types/app-frameworks.type";
import { ToolNames } from "../types/tool-names.enum";
import { createToolResponse } from "../utils";
import { createAppAction } from "../actions/create-app.action";
import { CreateAppParams } from "../types/create-app-params.type";
import { getVcsProvidersAction } from "../actions/get-vcs-providers.action";

const frameworks = [
  ...Object.values(FrameworksFrontend),
  ...Object.values(FrameworksBackend),
];

const inputSchema = {
  type: z
    .nativeEnum(AppTypes, {
      description: `–¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (frontend/backend). –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞`,
    })
    .describe(
      "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - —Ç–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (frontend –∏–ª–∏ backend)"
    ),

  provider_id: z
    .string({
      description: `ID –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ timeweb cloud. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.GET_VCS_PROVIDERS} –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö, —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—è tool ${ToolNames.ADD_VCS_PROVIDER}.`,
    })
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - ID VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"),

  repository_id: z
    .string({
      description: `ID —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ timeweb cloud. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.GET_VCS_PROVIDER_REPOSITORIES} –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º provider_id, –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é. –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö, –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏`,
    })
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - ID —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"),

  repository_url: z
    .string({
      description:
        "URL –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ—Å—Ç–∞—Ç—å –∏–∑ –ø–∞–ø–∫–∏ .git/refs/remotes/origin/, –Ω–µ –∑–∞–ø—É—Å–∫–∞—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ https://github.com/user/repo",
    })
    .url("URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º")
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"),

  preset_id: z
    .number({
      description: `ID –ø—Ä–µ—Å–µ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ timeweb cloud. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.GET_ALLOWED_PRESETS} –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã, –∏ –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞`,
    })
    .int("ID –ø—Ä–µ—Å–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º")
    .positive("ID –ø—Ä–µ—Å–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - ID –ø—Ä–µ—Å–µ—Ç–∞"),

  framework: z
    .union(
      [z.nativeEnum(FrameworksFrontend), z.nativeEnum(FrameworksBackend)],
      {
        description:
          "–§—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è package.json, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π. –ï—Å–ª–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å—Ç—å —Ñ–∞–π–ª—ã Dockerfile –∏–ª–∏ docker-compose, —Ç–æ —ç—Ç–æ backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–∏–ø–æ–º docker –∏–ª–∏ docker-compose. –ï—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
      }
    )
    .describe(
      "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (React, Vue, Angular, Next.js, Django, Express, Laravel, Docker –∏ –¥—Ä.). –ï—Å–ª–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å—Ç—å —Ñ–∞–π–ª—ã Dockerfile –∏–ª–∏ docker-compose, —Ç–æ —ç—Ç–æ backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–∏–ø–æ–º docker –∏–ª–∏ docker-compose."
    )
    .refine((framework) => frameworks.includes(framework), {
      message:
        "–§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö: " + frameworks.join(", "),
    }),

  commit_sha: z
    .string({
      description:
        "SHA –∫–æ–º–º–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ç–∫–∏. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ—Å—Ç–∞—Ç—å –∏–∑ .git/refs/remotes/origin/HEAD –∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≤–µ—Ç–∫–∏, –ù–ï –∑–∞–ø—É—Å–∫–∞—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–π SHA (40 —Å–∏–º–≤–æ–ª–æ–≤)",
    })
    .min(40, "SHA –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–π, –Ω–µ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π")
    .max(40, "SHA –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 40 —Å–∏–º–≤–æ–ª–æ–≤")
    .regex(
      /^[a-f0-9]{40}$/i,
      "SHA –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–µ—Ä–∏—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (a-f, 0-9)"
    )
    .refine((sha) => sha.trim().length === 40, {
      message: "SHA –∫–æ–º–º–∏—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 40 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–µ —Å—á–∏—Ç–∞—è –ø—Ä–æ–±–µ–ª—ã)",
    })
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - SHA –∫–æ–º–º–∏—Ç–∞ (40 —Å–∏–º–≤–æ–ª–æ–≤)"),

  branch_name: z
    .string({
      description:
        "–ê–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ç–∫–∞. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ—Å—Ç–∞—Ç—å –∏–∑ .git/HEAD, –Ω–µ –∑–∞–ø—É—Å–∫–∞—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.",
    })
    .refine((branch) => branch.trim().length > 0, {
      message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏",
    })
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏"),

  name: z
    .string({
      description: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (2-3 —Å–ª–æ–≤–∞).",
    })
    .min(3, "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞")
    .max(80, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 80 —Å–∏–º–≤–æ–ª–æ–≤)")
    .regex(
      /^[a-zA-Z–∞-—è–ê-–Ø0-9\s\-_]+$/,
      "–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è"
    )
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"),

  build_cmd: z
    .string({
      description: `–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±–æ—Ä–∫–∏. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞. –ú–û–ñ–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tool ${ToolNames.GET_DEPLOY_SETTINGS} –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`,
    })
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - –∫–æ–º–∞–Ω–¥–∞ —Å–±–æ—Ä–∫–∏"),

  envs: z
    .record(z.string(), {
      description:
        "–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.",
    })
    .describe(
      "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑–∞—Ç—å –∏—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ"
    )
    .default({}),

  comment: z
    .string({
      description: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é",
    })
    .min(1, "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
    .max(200, "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .refine((comment) => comment.trim().length > 0, {
      message: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤",
    })
    .default("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ MCP —Å–µ—Ä–≤–µ—Ä")
    .describe("–ù–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"),

  index_dir: z
    .string({
      description: `–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å index —Ñ–∞–π–ª–æ–º (–¢–û–õ–¨–ö–û –¥–ª—è frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tool ${ToolNames.GET_DEPLOY_SETTINGS} –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞.`,
    })
    .describe(
      "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï –¢–û–õ–¨–ö–û –¥–ª—è frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å index —Ñ–∞–π–ª–æ–º"
    ),

  run_cmd: z
    .string({
      description: `–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tool ${ToolNames.GET_DEPLOY_SETTINGS} –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π`,
    })
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï –¥–ª—è backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π - –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞"),

  system_dependencies: z
    .array(z.string(), {
      description:
        "–°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.",
    })
    .describe("–ù–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)")
    .default([]),

  is_auto_deploy: z
    .literal(false, {
      description: "–í–°–ï–ì–î–ê false –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ MCP —Å–µ—Ä–≤–µ—Ä",
    })
    .default(false)
    .describe("–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï - –≤—Å–µ–≥–¥–∞ false"),
};

const outputSchema = {
  id: z.number({
    description: "ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  name: z.string({
    description: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  ip: z.string({
    description: "IP –∞–¥—Ä–µ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  type: z.string({
    description: "–¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (frontend/backend)",
  }),
  domains: z.array(z.string(), {
    description: "–°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  framework: z.string({
    description: "–§—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  branch: z.string({
    description: "–í–µ—Ç–∫–∞ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è",
  }),
  comment: z.string({
    description: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é",
  }),
  preset_id: z.number({
    description: "ID –ø—Ä–µ—Å–µ—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏",
  }),
  is_auto_deploy: z.literal(false, {
    description: "–§–ª–∞–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è (–≤—Å–µ–≥–¥–∞ false)",
  }),
  availability_zone: z.string({
    description: "–ó–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏",
  }),
  configuration: z.object(
    {
      cpu: z.number({
        description: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU",
      }),
      ram: z.number({
        description: "–û–±—ä–µ–º RAM –≤ –ú–ë",
      }),
      network_bandwidth: z.number({
        description: "–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ç–∏",
      }),
      cpu_frequency: z.string({
        description: "–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞",
      }),
      disk_type: z.string({
        description: "–¢–∏–ø –¥–∏—Å–∫–∞",
      }),
    },
    {
      description: "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    }
  ),
};

const handler = async (params: CreateAppParams) => {
  try {
    const providers = await getVcsProvidersAction();
    const repositoryName = params.repository_url.split("/").pop()?.replace(".git", "");
    const provider = providers?.find(
      (provider) => repositoryName && provider.login.includes( repositoryName)
    );
    if (!provider) {
      return createToolResponse(
        `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è "${params.repository_url}". –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.ADD_VCS_PROVIDER}`
      );
    }

    
    const app = await createAppAction({...params, provider_id: provider.provider_id});

    if (!app) {
      return createToolResponse(
        `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "${params.name}" –≤ Timeweb Cloud`
      );
    }

    return createToolResponse(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "${app.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ –≤ Timeweb Cloud!

üìã –î–µ—Ç–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: ${app.name}
‚Ä¢ –¢–∏–ø: ${app.type}
‚Ä¢ –§—Ä–µ–π–º–≤–æ—Ä–∫: ${app.framework}
‚Ä¢ –í–µ—Ç–∫–∞: ${app.branch}
‚Ä¢ IP: ${app.ip}
${
  app.domains.length > 0
    ? `‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: ${app.domains[0].fqdn}`
    : ""
}
‚Ä¢ –ü—Ä–µ—Å–µ—Ç: ${app.preset_id}
${
  app.configuration
    ? `‚Ä¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${JSON.stringify(app.configuration)}`
    : ""
}

üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!`);
  } catch (error: unknown) {
    if (error instanceof Error) {
      return createToolResponse(
        `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–∏—á–∏–Ω–∞: ${error.message}`
      );
    }
    return createToolResponse(`‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`);
  }
};

export const createAppTool = {
  name: ToolNames.CREATE_TIMEWEB_APP,
  title: "–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Timeweb Cloud",
  description: `–°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Timeweb Cloud —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.`,
  inputSchema,
  outputSchema,
  handler,
};

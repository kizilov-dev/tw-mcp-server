import { z } from "zod";
import { AppTypes } from "../types/app-types.enum";
import {
  FrameworksBackend,
  FrameworksFrontend,
} from "../types/app-frameworks.type";
import { ToolNames } from "../types/tool-names.enum";
import { createToolResponse } from "../utils";
import { createAppAction } from "../actions/create-app.action";
import { CreateAppParams } from "../types/create-app-params.type";

const inputSchema = {
  type: z.nativeEnum(AppTypes, {
    description: `–¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (frontend/backend). –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞`,
  }),
  provider_id: z.string({
    description: `ID –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ timeweb cloud. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.GET_VCS_PROVIDERS} –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö, —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—è tool ${ToolNames.ADD_VCS_PROVIDER}.`,
  }),
  repository_id: z.string({
    description: `ID —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ timeweb cloud. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.GET_VCS_PROVIDER_REPOSITORIES} –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º provider_id, –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é. –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö, –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏`,
  }),
  repository_url: z.string({
    description:
      "URL –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ—Å—Ç–∞—Ç—å –∏–∑ –ø–∞–ø–∫–∏ .git/refs/remotes/origin/, –Ω–µ –∑–∞–ø—É—Å–∫–∞—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ https://github.com/user/repo",
  }),
  preset_id: z.number({
    description: `ID –ø—Ä–µ—Å–µ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ timeweb cloud. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å –ø–æ–º–æ—â—å—é tool ${ToolNames.GET_ALLOWED_PRESETS} –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã, –∏ –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞`,
  }),
  framework: z.union(
    [z.nativeEnum(FrameworksFrontend), z.nativeEnum(FrameworksBackend)],
    {
      description:
        "–§—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è package.json, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π. –ï—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    }
  ),
  commit_sha: z
    .string({
      description:
        "SHA –∫–æ–º–º–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ç–∫–∏. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ—Å—Ç–∞—Ç—å –∏–∑ .git/refs/remotes/origin/HEAD –∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≤–µ—Ç–∫–∏, –Ω–µ –∑–∞–ø—É—Å–∫–∞—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–π SHA (40 —Å–∏–º–≤–æ–ª–æ–≤)",
    })
    .min(40, "SHA –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–π, –Ω–µ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π"),
  branch_name: z
    .string({
      description:
        "–ê–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ç–∫–∞. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ—Å—Ç–∞—Ç—å –∏–∑ .git/HEAD, –Ω–µ –∑–∞–ø—É—Å–∫–∞—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –ï—Å–ª–∏ –≤–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å main –∏–ª–∏ master –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
    })
    .default("main"),
  name: z
    .string({
      description: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (2-3 —Å–ª–æ–≤–∞).",
    })
    .min(3, "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞"),
  build_cmd: z
    .string({
      description:
        "–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±–æ—Ä–∫–∏. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π",
    })
    .optional(),
  envs: z
    .record(z.string(), {
      description:
        "–ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ü–†–û–°–ò–¢–¨ –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø! –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∑–Ω–∞—á–µ–Ω–∏—è - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —è–≤–Ω–æ",
    })
    .optional(),
  comment: z
    .string({
      description: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é",
    })
    .default("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —á–µ—Ä–µ–∑ MCP —Å–µ—Ä–≤–µ—Ä"),
  index_dir: z
    .string({
      description: "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å index —Ñ–∞–π–ª–æ–º (–¥–ª—è frontend)",
    })
    .optional(),
  run_cmd: z
    .string({
      description:
        "–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π",
    })
    .optional(),
  system_dependencies: z
    .array(z.string(), {
      description:
        "–°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É",
    })
    .optional(),
  is_auto_deploy: z
    .literal(false, {
      description: "–í–°–ï–ì–î–ê false –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ MCP —Å–µ—Ä–≤–µ—Ä",
    })
    .default(false),
};

const outputSchema = {
  id: z.number({
    description: "ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  name: z.string({
    description: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  ip: z.string({
    description: "IP –∞–¥—Ä–µ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  type: z.string({
    description: "–¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (frontend/backend)",
  }),
  domains: z.array(z.string(), {
    description: "–°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  framework: z.string({
    description: "–§—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  }),
  branch: z.string({
    description: "–í–µ—Ç–∫–∞ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è",
  }),
  comment: z.string({
    description: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é",
  }),
  preset_id: z.number({
    description: "ID –ø—Ä–µ—Å–µ—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏",
  }),
  is_auto_deploy: z.literal(false, {
    description: "–§–ª–∞–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è (–≤—Å–µ–≥–¥–∞ false)",
  }),
  availability_zone: z.string({
    description: "–ó–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏",
  }),
  configuration: z.object(
    {
      cpu: z.number({
        description: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU",
      }),
      ram: z.number({
        description: "–û–±—ä–µ–º RAM –≤ –ú–ë",
      }),
      network_bandwidth: z.number({
        description: "–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ç–∏",
      }),
      cpu_frequency: z.string({
        description: "–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞",
      }),
      disk_type: z.string({
        description: "–¢–∏–ø –¥–∏—Å–∫–∞",
      }),
    },
    {
      description: "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    }
  ),
};

const handler = async (params: CreateAppParams) => {
  try {
    const app = await createAppAction(params);

    if (!app) {
      return createToolResponse(
        `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "${params.name}" –≤ Timeweb Cloud`
      );
    }

    return createToolResponse(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "${
      app.name
    }" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ –≤ Timeweb Cloud!

üìã –î–µ—Ç–∞–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: ${app.name}
‚Ä¢ –¢–∏–ø: ${app.type}
‚Ä¢ –§—Ä–µ–π–º–≤–æ—Ä–∫: ${app.framework}
‚Ä¢ –í–µ—Ç–∫–∞: ${app.branch}
‚Ä¢ IP: ${app.ip}
${
  app.domains.length > 0
    ? `‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: ${app.domains.join(", ")}`
    : ""
}
‚Ä¢ –ü—Ä–µ—Å–µ—Ç: ${app.preset_id}
${
  app.configuration
    ? `‚Ä¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${JSON.stringify(app.configuration)}`
    : ""
}

üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!`);
  } catch (error: unknown) {
    if (error instanceof Error) {
      return createToolResponse(
        `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–∏—á–∏–Ω–∞: ${error.message}`
      );
    }
    return createToolResponse(`‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`);
  }
};

export const createAppTool = {
  name: ToolNames.CREATE_TIMEWEB_APP,
  title: "–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Timeweb Cloud",
  description: `–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Timeweb Cloud —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.

    üîç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –û–ü–†–ï–î–ï–õ–Ø–ï–¢–°–Ø:
    ‚Ä¢ –¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (frontend/backend) –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞
    ‚Ä¢ –§—Ä–µ–π–º–≤–æ—Ä–∫ (React, Vue, Angular, Next.js, Django, Express, Laravel –∏ –¥—Ä.)
    ‚Ä¢ –ö–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞
    ‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    ‚Ä¢ VCS –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    ‚Ä¢ –ü—Ä–µ—Å–µ—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

    üìã –î–û–°–¢–ê–ï–¢–°–Ø –ò–ó –ü–†–û–ï–ö–¢–ê:
    ‚Ä¢ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–∑ .git/config
    ‚Ä¢ SHA –∫–æ–º–º–∏—Ç–∞ –∏–∑ .git/refs
    ‚Ä¢ –ê–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ç–∫–∞ –∏–∑ .git/HEAD

    ‚ùì –¢–†–ï–ë–£–ï–¢ –í–í–û–î–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
    ‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (envs) - –ö–†–ò–¢–ò–ß–ù–û!

    –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö.`,
  inputSchema,
  outputSchema,
  handler,
};
